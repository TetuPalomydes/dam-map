# 砦攻略システム（C:\corsor\_砦攻略システム）との連動

遠征マップで **攻略済・失** の砦を薄く表示するには、砦攻略システムのステータスを `fort_status.json` として用意します。

---

## 完全自動連動（常に最新を表示）

砦攻略のステータスを更新すると、**遠征マップを開くたびに自動で最新**が反映されます。手動でJSONをダウンロード・配置する必要はありません。

### 手順

1. **砦攻略システムを Vercel にデプロイする**  
   - 砦攻略PWA（`C:\corsor\_砦攻略システム\pwa`）を Vercel にデプロイし、**環境変数**に `VITE_SUPABASE_URL` と `VITE_SUPABASE_ANON_KEY` を設定する（既に設定済みならそのまま）。
   - デプロイ後のURLを控える（例: `https://npc-strategy-xxx.vercel.app`）。

2. **遠征システムで API URL を設定する**  
   - 遠征システムの **`gen_map_from_csv.py`** を開き、先頭付近の `FORT_STATUS_URL` を砦攻略のAPIに書き換える。
   ```python
   FORT_STATUS_URL = "https://npc-strategy-xxx.vercel.app/api/fort_status"
   ```
   - イベントが E1 の場合は `?event=e1` を付ける。
   ```python
   FORT_STATUS_URL = "https://npc-strategy-xxx.vercel.app/api/fort_status?event=e1"
   ```

3. **マップを再生成する**  
   - 遠征システムのフォルダで `python gen_map_from_csv.py` を実行し、`遠征計画_座標マップ.html` を更新する。

4. **遠征マップを開く**  
   - マップ（ローカルまたは GitHub Pages）を開くと、砦攻略API から攻略状況を取得し、攻略済・失を薄く表示する。**更新のたびに常に最新**になる。

### 仕組み

- 砦攻略PWAに **`/api/fort_status`**（Vercel Serverless）を追加済み。このAPIが Supabase から `npc_name` と `strategy_status` を取得して JSON で返す。
- 遠征マップのHTMLは、`FORT_STATUS_URL` が設定されているときはそのURLを fetch し、未設定のときは従来どおり同梱の `fort_status.json` を参照する。

### 注意

- 遠征マップを **GitHub Pages** で公開している場合、砦攻略のAPI側で **CORS** を許可しているため、別ドメインからの fetch で取得できる（`Access-Control-Allow-Origin: *` を返す実装済み）。
- 砦攻略のVercel環境変数（Supabase）が正しく設定されていないと API が 500 を返す。その場合はマップは従来どおり「薄くしない」表示になる（fetch が失敗するだけ）。

---

## 半自動：JSON を手動で配置する場合

完全自動（API連動）を使わず、ファイルで渡す場合の方法です。

1. 砦攻略の **API URL**（`https://あなたの砦攻略.vercel.app/api/fort_status`）をブラウザで開き、表示されたJSONを `fort_status.json` として保存する。
2. そのファイルを **遠征システム** のフォルダ（`遠征計画_座標マップ.html` と同じ場所）に置く。GitHub Pages の場合はコミット・プッシュする。
3. **座標マップ**を開くと、攻略済・失が薄く表示される（`gen_map_from_csv.py` の `FORT_STATUS_URL` は空のまま）。

## 代替：CSV から遠征側で生成

1. 砦攻略システムのテーブルを CSV でエクスポートし、遠征システムに置く（例: `npc_strategy_em6_rows.csv`）。
2. 遠征システムで `python make_fort_status_json.py` を実行 → `fort_status.json` が生成される。
3. 以降は上記「座標マップを開く」と同じ。

## ファイル配置

| ファイル | 説明 |
|----------|------|
| `npc_strategy_em6_rows.csv` | 砦攻略システムからエクスポートしたCSV（`npc_name`, `strategy_status` 列を含む） |
| `fort_status.json` | 上記CSVから `make_fort_status_json.py` が生成。マップHTMLと同梱または同じURL階層に置く |
| `遠征計画_座標マップ.html` | `fort_status.json` を fetch して済・失を薄く描画 |

## GitHub Pages で公開する場合

- マップHTML と **fort_status.json** を同じリポジトリにコミットし、同じパスにデプロイする。
- ステータスを更新したら、砦攻略側でCSVをエクスポート → `make_fort_status_json.py` 実行 → 生成した `fort_status.json` をコミット＆プッシュすると、マップに反映される。

## 砦攻略システム側

- デプロイ先の **`/api/fort_status`** が Supabase から攻略状況を返す（完全自動連動で遠征マップが参照）。クエリ `?event=w`（省略可）／`?event=e1` でイベント指定。
- CSV から `fort_status.json` を生成する場合は、Supabase でエクスポートし、遠征側で `make_fort_status_json.py` を実行できます。
